@page "/"
@implements IDisposable
@inject EditorState Editor
@inject ViewportService Viewport
@inject IJSRuntime Js
@inject ToastService Toasts

<PageTitle>R4Everyone</PageTitle>

@if (!_isDesktop)
{
    <div class="desktop-warning">
        <div class="card shadow-sm">
            <div class="card-body">
                <h1 class="h4 mb-2">Desktop required</h1>
                <p class="mb-0">This app is designed for desktop. Please open it on a desktop browser.</p>
            </div>
        </div>
    </div>
}
else
{
    <div class="app-shell">
        <AppHeaderBar FileName="@Editor.LoadedFileName" HasLoadedFile="Editor.HasLoadedFile" IsDirty="Editor.IsDirty"
                      IsValid="Editor.IsValid" Errors="Editor.ValidationErrors"/>

        <div class="app-body container-fluid">
            <div class="row h-100 g-3">
                <div class="col-lg-3 h-100 d-flex flex-column gap-3">
                    <FileControlsPanel CanSave="CanSave" OnNew="Editor.NewFile" OnOpen="OnOpenFileSelected"
                                       OnSave="SaveAsync"/>

                    <TreePanel Database="Editor.Database" Selected="SelectedItem"/>
                </div>

                <div class="col-lg-9 h-100 d-flex flex-column gap-3">
                    <DetailsPanel Header="@DetailsHeader"
                                  SelectionKind="Editor.SelectionKind"
                                  Game="Editor.SelectedGame"
                                  Folder="Editor.SelectedFolder"
                                  Cheat="Editor.SelectedCheat"
                                  MasterCodes="MasterCodes"
                                  CheatCodeRows="CheatCodeRows"
                                  OnGameIdInput="OnGameIdInput"
                                  OnGameTitleInput="OnGameTitleInput"
                                  OnGameChecksumInput="OnGameChecksumInput"
                                  OnGameEnabledChanged="OnGameEnabledChanged"
                                  OnMasterCodeInput="OnMasterCodeInput"
                                  OnRomFileSelected="OnRomFileSelected"
                                  OnFolderTitleInput="OnFolderTitleInput"
                                  OnFolderDescriptionInput="OnFolderDescriptionInput"
                                  OnFolderOneHotChanged="OnFolderOneHotChanged"
                                  OnCheatTitleInput="OnCheatTitleInput"
                                  OnCheatDescriptionInput="OnCheatDescriptionInput"
                                  OnCheatEnabledChanged="OnCheatEnabledChanged"
                                  OnCheatBlockInput="OnCheatBlockInput"
                                  OnAddCheatRow="AddCheatRow"
                                  OnRemoveCheatRow="RemoveCheatRow"/>

                    <ActionsPanel CanAddGame="true"
                                  CanAddFolder="CanAddFolder"
                                  CanAddCheat="CanAddCheat"
                                  CanRemoveGame="CanRemoveGame"
                                  CanRemoveFolder="CanRemoveFolder"
                                  CanRemoveCheat="CanRemoveCheat"
                                  IsValid="Editor.IsValid"
                                  Errors="Editor.ValidationErrors"
                                  OnAddGame="Editor.AddGame"
                                  OnAddFolder="Editor.AddFolder"
                                  OnAddCheat="Editor.AddCheat"
                                  OnRemoveGame="Editor.RemoveSelected"
                                  OnRemoveFolder="Editor.RemoveSelected"
                                  OnRemoveCheat="Editor.RemoveSelected"/>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool _isDesktop = true;

    private string DetailsHeader => Editor.SelectionKind switch
    {
        SelectionKind.Game => "Game Details",
        SelectionKind.Folder => "Folder Details",
        SelectionKind.Cheat => "Cheat Details",
        _ => "Select an item"
    };

    private bool CanSave => Editor.HasLoadedFile && Editor.IsDirty && Editor.IsValid;
    private bool CanAddFolder => Editor.SelectionKind == SelectionKind.Game;
    private bool CanAddCheat => Editor.SelectionKind == SelectionKind.Game || Editor.SelectionKind == SelectionKind.Folder;
    private bool CanRemoveGame => Editor.SelectionKind == SelectionKind.Game;
    private bool CanRemoveFolder => Editor.SelectionKind == SelectionKind.Folder;
    private bool CanRemoveCheat => Editor.SelectionKind == SelectionKind.Cheat;

    private object? SelectedItem => (object?)Editor.SelectedCheat ?? (object?)Editor.SelectedFolder ?? Editor.SelectedGame;

    private string[] MasterCodes => Editor.SelectedGame == null
        ? []
        : Editor.GetMasterCodeText(Editor.SelectedGame)
            .Select(ToBigEndianHex)
            .ToArray();

    private List<string> CheatCodeRows => Editor.SelectedCheat == null
        ? []
        : Editor.GetCheatCodeBlocks(Editor.SelectedCheat)
            .Select(ToBigEndianHex)
            .ToList();

    protected override void OnInitialized()
    {
        Editor.StateChanged += HandleStateChanged;
        Viewport.ViewportChanged += HandleViewportChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Viewport.InitializeAsync();
            _isDesktop = Viewport.IsDesktop;
            StateHasChanged();
        }
    }

    private void HandleStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void HandleViewportChanged()
    {
        _isDesktop = Viewport.IsDesktop;
        InvokeAsync(StateHasChanged);
    }

    private void OnGameIdInput(ChangeEventArgs args)
    {
        Editor.UpdateGameId(args.Value?.ToString() ?? string.Empty);
    }

    private void OnGameTitleInput(ChangeEventArgs args)
    {
        Editor.UpdateGameTitle(args.Value?.ToString() ?? string.Empty);
    }

    private void OnGameChecksumInput(ChangeEventArgs args)
    {
        Editor.UpdateGameChecksum(args.Value?.ToString() ?? string.Empty);
    }

    private void OnGameEnabledChanged(ChangeEventArgs args)
    {
        Editor.UpdateGameEnabled(args.Value is bool and true);
    }

    private void OnMasterCodeInput(int index, ChangeEventArgs args)
    {
        if (Editor.SelectedGame == null)
        {
            return;
        }

        var input = args.Value?.ToString() ?? string.Empty;
        Editor.UpdateMasterCode(Editor.SelectedGame, index, ToLittleEndianHex(input));
    }

    private void OnFolderTitleInput(ChangeEventArgs args)
    {
        Editor.UpdateFolderTitle(args.Value?.ToString() ?? string.Empty);
    }

    private void OnFolderDescriptionInput(ChangeEventArgs args)
    {
        Editor.UpdateFolderDescription(args.Value?.ToString() ?? string.Empty);
    }

    private void OnFolderOneHotChanged(ChangeEventArgs args)
    {
        Editor.UpdateFolderOneHot(args.Value is true);
        if (args.Value is true)
            Toasts.ShowInfo("Because 'One Hot' has been enabled, all cheats except the first 'Enabled' cheat (if any) have been disabled. Only one cheat can be enabled in a 'One Hot' folder at a time.");
    }

    private void OnCheatTitleInput(ChangeEventArgs args)
    {
        Editor.UpdateCheatTitle(args.Value?.ToString() ?? string.Empty);
    }

    private void OnCheatDescriptionInput(ChangeEventArgs args)
    {
        Editor.UpdateCheatDescription(args.Value?.ToString() ?? string.Empty);
    }

    private void OnCheatEnabledChanged(ChangeEventArgs args)
    {
        Editor.UpdateCheatEnabled(args.Value is true);
    }

    private void OnCheatBlockInput(int index, ChangeEventArgs args)
    {
        if (Editor.SelectedCheat == null)
        {
            return;
        }

        var input = args.Value?.ToString() ?? string.Empty;
        Editor.UpdateCheatBlock(Editor.SelectedCheat, index, ToLittleEndianHex(input));
    }

    private void AddCheatRow()
    {
        if (Editor.SelectedCheat == null)
        {
            return;
        }

        Editor.AddCheatRow(Editor.SelectedCheat);
    }

    private void RemoveCheatRow(int rowIndex)
    {
        if (Editor.SelectedCheat == null)
        {
            return;
        }

        Editor.RemoveCheatRow(Editor.SelectedCheat, rowIndex);
    }

    private async Task OnRomFileSelected(InputFileChangeEventArgs args)
    {
        if (Editor.SelectedGame == null)
        {
            return;
        }

        var file = args.File;
        // Allows files of any size to be open, since we're only reading the first 512 bytes and it's local anyways.
        await using var stream = file.OpenReadStream(int.MaxValue);
        var buffer = new byte[512];
        var bytesRead = await stream.ReadAsync(buffer);

        if (bytesRead > 0)
        {
            var data = buffer.Take(bytesRead).ToArray();
            Editor.ApplyRomMetadata(data);
        }
    }

    private async Task OnOpenFileSelected(InputFileChangeEventArgs args)
    {
        var file = args.File;
        await using var stream = file.OpenReadStream(int.MaxValue);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        ms.Position = 0;
        await Editor.LoadAsync(ms, file.Name);
    }

    private async Task SaveAsync()
    {
        if (!CanSave)
        {
            return;
        }

        var bytes = await Editor.BuildSaveBytesAsync();
        if (bytes == null)
        {
            return;
        }

        var fileName = string.IsNullOrWhiteSpace(Editor.LoadedFileName) ? "cheats.dat" : Editor.LoadedFileName;
        await Js.InvokeVoidAsync("downloadFile", fileName, "application/octet-stream", bytes);
        Editor.MarkSaved();
    }

    public void Dispose()
    {
        Editor.StateChanged -= HandleStateChanged;
        Viewport.ViewportChanged -= HandleViewportChanged;
    }

    private static string ToBigEndianHex(string value)
    {
        return ReverseEndianHex(value);
    }

    private static string ToLittleEndianHex(string value)
    {
        return ReverseEndianHex(value);
    }

    private static string ReverseEndianHex(string value)
    {
        if (value.Length != 8)
        {
            return value;
        }

        return string.Concat(
            value.AsSpan(6, 2),
            value.AsSpan(4, 2),
            value.AsSpan(2, 2),
            value.AsSpan(0, 2));
    }

}
