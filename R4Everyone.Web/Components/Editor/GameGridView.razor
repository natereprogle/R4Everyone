<div class="game-grid">
    @if (Games == null || Games.Count == 0)
    {
        <div class="empty-state">No games yet. Create or open a file to begin.</div>
    }
    else
    {
        @foreach (var game in Games)
        {
            var title = EditorState.GetGameDisplayTitle(game);
            var imageUrl = GetImageUrl(game);
            var isLoading = IsLoading(game);
            <button type="button" class="game-tile" @onclick="() => OnGameSelected.InvokeAsync(game)">
                @if (!string.IsNullOrWhiteSpace(imageUrl))
                {
                    <object type="image/jpeg" data="@imageUrl" class="game-tile-image" alt="@title">
                        <img src="assets/failed_cover_fetch.webp" alt="@title | Failed to fetch cover art"/>
                    </object>
                }
                else
                {
                    <div class="game-image-frame">
                        <img class="game-tile-image @(isLoading ? "loading" : "")" src="assets/unknown_game_cover.webp"
                             alt="Unknown cover art"/>
                        @if (isLoading)
                        {
                            <div class="game-image-loading-bar"></div>
                        }
                    </div>
                }
                <div class="game-tile-body">
                    <div class="game-tile-title">@title</div>
                    @if (!string.IsNullOrWhiteSpace(game.GameId))
                    {
                        <div class="game-tile-subtitle">@game.GameId</div>
                    }
                </div>
            </button>
        }
    }
</div>

@code {
    [Parameter] public IReadOnlyList<R4Game>? Games { get; set; }
    [Parameter] public EventCallback<R4Game> OnGameSelected { get; set; }
    [Parameter] public Func<R4Game, Task<string?>>? ImageUrlSelector { get; set; }
    private readonly Dictionary<R4Game, (string GameId, Task<string?> Task, DateTime StartedAt)> _imageTasks = new();

    protected override async Task OnParametersSetAsync()
    {
        if (Games == null || ImageUrlSelector == null)
        {
            _imageTasks.Clear();
            return;
        }

        foreach (var game in Games)
        {
            var gameId = game.GameId;
            if (_imageTasks.TryGetValue(game, out var entry) && entry.GameId == gameId)
                continue;

            _imageTasks[game] = (gameId, LoadImageAsync(game), DateTime.UtcNow);
        }

        var currentGames = new HashSet<R4Game>(Games);
        foreach (var game in _imageTasks.Keys.ToList().Where(game => !currentGames.Contains(game)))
            _imageTasks.Remove(game);

        await Task.CompletedTask;
    }

    private async Task<string?> LoadImageAsync(R4Game game)
    {
        if (ImageUrlSelector == null) return null;

        _ = Task.Delay(TimeSpan.FromSeconds(10)).ContinueWith(_ => InvokeAsync(StateHasChanged));
        var url = await ImageUrlSelector(game);
        await InvokeAsync(StateHasChanged);
        return url;
    }

    private string? GetImageUrl(R4Game game)
    {
        if (_imageTasks.TryGetValue(game, out var entry) && entry.Task.IsCompletedSuccessfully)
            return entry.Task.Result;

        return null;
    }

    private bool IsLoading(R4Game game)
    {
        if (!_imageTasks.TryGetValue(game, out var entry))
            return false;

        if (entry.Task.IsCompletedSuccessfully && !string.IsNullOrWhiteSpace(entry.Task.Result))
            return false;
        
        return DateTime.UtcNow - entry.StartedAt < TimeSpan.FromSeconds(10);
    }

}
